---
title: '金融级业务下分布式事务保证数据一致性'
date: 2020-06-22 10:27:01
tags: [分布式事务]
published: true
hideInList: false
feature: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1592810980804&di=aad11833d3e9a342e1790191768476b3&imgtype=0&src=http%3A%2F%2Fa3.att.hudong.com%2F47%2F65%2F20300543745352145671650930126.jpg
isTop: false
---
## 前言
> 随着分布式服务架构的流行与普及，原来在单体应用中执行的多个逻辑操作，现在被拆分成了多个服务之间的远程调用。微服务化后，随着带来的服务之间的分布式事务问题，尤其是在金融业务下，分布式事务是保证数据一致性的重要保证。本文着重会讲分布式事务场景和业界主流的解决方案。

## 引入
&emsp;资金转账在金融业务下是一个非常重要而且常见的场景，如果因为技术问题导致资金转账错误，导致数据不一致问题，那么就会造成无法预测的后果。
&emsp;笔者这里拿银行转账的例子来说（这里的转账有很多场景比如银行卡之间充值提现、银行账户之间的转账等等），比如甲银行账户A向乙银行账户B转账1W：

同步调用：
1. A银行对转出账户执行检查校验，进行账户金额扣减。
2. A银行同步调用B银行转账接口。
3. B银行对转入账户进行检查校验，进行账户金额增加。
4. B银行返回处理结果给A银行。
  
同步调用问题：
*  如果B银行因为网络原因导致接口不通，那么A调用线程会长时间阻塞。
*  如果A扣减后，发送请求后，在网络中丢失了，B银行没有收到请求，导致账户A扣减了，账户B没有加
* 如果账户B扣减成功了，由于某种原因比如网络异常没有及时回调给甲银行，那么账户A就认为是异常请求，则会回滚事务，导致数据不一致。

再来看一下异步调用：
1. A银行对转出账户执行检查校验，进行账户金额扣减。
2. 主线程将请求数据异步写入队列MQ
2. 真正消费者程序对B银行进行远程调用
4. B银行对转入账户进行检查校验，进行账户金额增加。
5. B银行返回处理结果给A银行。

异步调用问题：
* 如果账户A扣减本地事务成功了，但是消息发出后，因为网络原因或者其他宕机原因，导致消息未发送成功，没有进行B账户远程调用，导致本地事务和消息不一致性。
* 在B账户成功完成账户增加后，在回调A银行接口通知回滚时网络异常或者宕机，会导致A银行转账无法完成回滚，从而导致数据不一致。

异步调用解决了同步调用的主线程阻塞问题，但还是没有解决数据一致性问题。而且引入MQ中间后，还要考虑到本地事务和MQ消息一致性问题，还有其他的引入后的维护工作，比如消息丢失，消息重发等等问题。

## 分布式事务解决方案
&emsp;讲到了分布式事务，自然离不开分布式系统的一些基本原则和定理：CAP原则和BASE理论，相信读者应该都知道，这里不做过多阐述。业界根据这些规则和理论，衍生出了各种分布式事务解决方案：XA规范，2PC，3PC，本地消息表方案，基于消息中间件的最终一致性方案，TCC方案，阿里的SEATA，SAGA方案和最大努力通知等等。
&emsp;以上每个方案都有自己的应用场景，就拿2PC来说，MySQL的事务型日志redolog二段提交（redolog(prepare)--》undolog--》redolog(commit)），Zookeeper的proposal事务提案二段提交（半数以上ack返回成功表示写入数据成功），这些都是2PC的应用。
&emsp;金融场景下类似资金业务需要保证最终一致性解决分布式事务，不需要保证转账实时性。所以本地消息表、基于MQ中间件的最终一致性等柔性方案是首选的方案。


### 本地消息表解决银行转账一致性问题

### 银行交易冲正

### 事务消息解决本地事务和MQ消息一致性问题

#### 消费端重复消费

#### 消费端消费失败

## 参考
- 有赞出金系统——https://tech.youzan.com/build-a-withdraw-sys/